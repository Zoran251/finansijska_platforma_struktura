// Enkapsulacija baze znanja za chatbot koristeći IIFE (Immediately Invoked Function Expression)
(function(global) {
    "use strict";
    
    // Privatna baza znanja - potpuno sakrivena od globalnog scope-a
    var knowledgeBase = {
        greeting: {
            response: "Zdravo! Ja sam vaš AI finansijski asistent. Kako vam mogu pomoći sa vašim finansijskim pitanjima danas?",
            keywords: ["zdravo", "pozdrav", "hi", "hello", "bok", "dobar dan", "dobro veče", "dobro jutro", "ćao", "cao", "hey"]
        },
        default: {
            response: "Izvinite, trenutno ne mogu da pronađem odgovor na vaše pitanje. Molim vas kontaktirajte našu korisničku podršku za detaljnije informacije ili pokušajte da preformulišete pitanje.",
            keywords: []
        },
        investment_intent: {
            response: "Razumem da želite da započnete sa investiranjem i to je odlična odluka! Za personalizovanu strategiju ulaganja koja će biti prilagođena vašim ciljevima i toleranciji na rizik, preporučujem da zakažete besplatne konsultacije sa našim finansijskim savetnikom. On će vam pomoći da napravite plan koji najbolje odgovara vašoj situaciji i finansijskim ciljevima. Kliknite na dugme \"Zakažite konsultacije\" da rezervišete svoj termin.",
            keywords: []  // Ključne reči za ovu kategoriju se određuju u findBestMatch funkciji
        },
        investicije: {
            response: "Investiranje je proces ulaganja novca sa ciljem ostvarivanja budućeg profita. Preporučujem da počnete sa diversifikovanim portfoliom koji uključuje:\n\n1. Akcije (40-60%) - veći potencijal rasta, viši rizik\n2. Obveznice (20-30%) - stabilniji prihod, niži rizik\n3. Nekretnine ili REIT fondove (10-20%) - zaštita od inflacije\n4. Gotovinu ili kratkoročne instrumente (5-10%) - likvidnost i sigurnost\n\nZa početak investiranja, ETF fondovi koji prate široko tržište (kao S&P 500) su odlična opcija zbog niskih troškova i dobre diverzifikacije.",
            keywords: ["investicija", "investiranje", "ulaganje", "akcije", "obveznice", "etf", "fond", "berza", "dividenda", "trgovanje", "berzanski indeks", "portfolio", "portfelj", "prinos", "tržište", "tržišna vrednost", "složena kamata", "dugoročno ulaganje", "kamata na kamatu"]
        },
        štednja: {
            response: "Za efikasnu štednju preporučujem '50/30/20' pravilo koje finansijski stručnjaci često predlažu:\n\n- 50% prihoda za osnovne potrebe (stanovanje, hrana, prevoz)\n- 30% za želje i dodatne troškove (zabava, putovanja, restorani)\n- 20% za štednju i investicije (hitni fond, dugoročna štednja)\n\nTakođe, važno je prvo izgraditi hitni fond koji pokriva 3-6 meseci troškova, a zatim razmisliti o namenskom štednom računu sa povoljnom kamatnom stopom ili investiranju za dugoročne ciljeve.",
            keywords: ["štednja", "stednja", "štedeti", "stedeti", "ušteda", "usteda", "štedni račun", "stedni racun", "kako uštedeti", "štedim", "staviti sa strane", "štedjeti", "ušteđevina", "čuvanje novca", "ostavljanje novca", "hitni fond"]
        },
        budžet: {
            response: "Za kreiranje efikasnog budžeta koji će poboljšati vašu finansijsku situaciju, pratite ove korake:\n\n1. Izračunajte sve mesečne prihode (plata, honorari, prihodi od investicija)\n2. Identifikujte fiksne troškove (kirija/kredit, komunalije, osiguranja, rate)\n3. Odredite varijabilne troškove (hrana, gorivo, zabava, kupovina)\n4. Postavite konkretne ciljeve štednje (kratkoročne i dugoročne)\n5. Koristite našu aplikaciju za kontinuirano praćenje i analizu\n\nPreporučujemo da budžet redovno reviditate (mesečno) i prilagođavate prema promenama prihoda i troškova.",
            keywords: ["budžet", "budzet", "budžetiranje", "budzetiranje", "troškovi", "troskovi", "prihodi", "rashodi", "planiranje novca", "planiranje troškova", "finansijski plan", "mesečni plan", "kako napraviti budžet", "kontrola troškova", "smanjenje troškova", "raspoređivanje novca"]
        },
        kredit: {
            response: "Pre uzimanja kredita, važno je razmotriti sledeće faktore:\n\n1. Kamatnu stopu i EKS (efektivna kamatna stopa koja uključuje sve troškove)\n2. Period otplate i kako utiče na ukupne troškove kredita\n3. Mesečnu ratu u odnosu na vaše prihode (idealno ispod 30%)\n4. Dodatne troškove i naknade (obrada, osiguranje, prevremena otplata)\n5. Fiksna vs. varijabilna kamata i rizike koje nosi svaka opcija\n\nZlatno pravilo je da rata kredita ne bi trebalo da prelazi 30% vaših mesečnih prihoda, a za stambene kredite do 40% uz odgovarajuću analizu.",
            keywords: ["kredit", "krediti", "pozajmica", "zajam", "rata", "kamata", "eks", "kredit za stan", "stambeni kredit", "gotovinski kredit", "pozajmica", "kreditna sposobnost", "refinansiranje", "hipoteka", "keš kredit", "kamata na kredit", "kako dobiti kredit", "kreditni rejting"]
        },
        porezi: {
            response: "Osnovne informacije o porezima koje treba da znate:\n\n1. Porez na dohodak građana (10-20% zavisno od visine prihoda)\n2. PDV - porez na dodatu vrednost (20% standardna stopa, 10% povlašćena)\n3. Porez na imovinu (različite stope zavisno od lokacije i vrednosti)\n4. Porez na kapitalni dobitak (15% na razliku prodajne i nabavne cene imovine)\n5. Doprinosi za socijalno osiguranje (PIO, zdravstveno, nezaposlenost)\n\nPoresko planiranje je važan deo finansijske strategije. Za optimizaciju vaše poreske situacije i moguće olakšice, preporučujem konsultaciju sa poreskim savetnikom.",
            keywords: ["porez", "porezi", "pdv", "dohodak", "imovina", "kapitalni dobitak", "poreska prijava", "poreske olakšice", "godišnji porez", "plaćanje poreza", "povraćaj poreza", "poreski odbici", "porez na nekretnine", "porez na dividendu", "porez na zarade"]
        },
        kriptovalute: {
            response: "Investiranje u kriptovalute nosi visok rizik i zahteva poseban oprez:\n\n1. Izuzetno volatilno tržište - cene mogu značajno oscilirati u kratkom periodu\n2. Potrebno temeljno istraživanje - razumevanje tehnologije i tržišnih faktora\n3. Investirajte samo onoliko koliko ste spremni da izgubite\n4. Diversifikujte portfolio umesto ulaganja u samo jednu kriptovalutu\n5. Bezbednost je ključna - koristite sigurne novčanike i pouzdane platforme za trgovanje\n\nPreporučujem da kriptovalute čine maksimalno 5-10% vašeg ukupnog investicionog portfolia, zavisno od vaše tolerancije na rizik. Za složenije strategije ulaganja u kriptovalute, razmislite o konsultaciji sa stručnjakom.",
            keywords: ["kripto", "kriptovalute", "bitcoin", "ethereum", "bitkoin", "btc", "eth", "altcoin", "blockchain", "rudarenje", "mining", "token", "wallet", "novčanik za kriptovalute", "defi", "nft", "stablecoin", "binance", "coinbase"]
        },
        osiguranje: {
            response: "Osnovni tipovi osiguranja koje bi trebalo razmotriti za potpunu finansijsku zaštitu:\n\n1. Životno osiguranje - zaštita porodice u slučaju smrti osiguranika\n2. Zdravstveno osiguranje - pokriće troškova lečenja i medicinskih usluga\n3. Osiguranje imovine - zaštita od štete na nekretninama i vrednoj pokretnoj imovini\n4. Osiguranje od nezgode - zaštita u slučaju povreda ili trajnog invaliditeta\n5. Osiguranje od odgovornosti - zaštita od odštetnih zahteva trećih lica\n6. Putno osiguranje - za zaštitu tokom putovanja\n\nOsiguranje treba prilagoditi vašoj životnoj situaciji, porodičnim okolnostima i vrednosti imovine. Za izbor najadekvatnijih polisa i pokrića, preporučujem konsultaciju sa stručnjakom.",
            keywords: ["osiguranje", "polisa", "životno", "zivotno", "zdravstveno", "imovina", "nezgoda", "osigurati", "osiguravajuće društvo", "premija osiguranja", "korisnik osiguranja", "osigurani slučaj", "kasko", "autoosiguranje", "dopunsko osiguranje", "rizik", "nadoknada štete", "osigurana suma"]
        },
        penzija: {
            response: "Za uspešno planiranje penzije koja će vam omogućiti finansijski komfor u starijim godinama:\n\n1. Počnite štedeti što ranije - čak i mali iznosi mogu značajno narasti zahvaljujući složenoj kamati\n2. Iskoristite državni penzioni fond (prvi stub) kao osnovu\n3. Razmotrite privatne penzione fondove (drugi i treći stub) za dodatnu sigurnost\n4. Investirajte dugoročno u diversifikovani portfolio\n5. Redovno povećavajte iznos štednje kako rastu vaši prihodi\n\nFinansijski stručnjaci preporučuju da težite ka 70-80% vaših trenutnih primanja za period penzije. Naša kalkulacija pokazuje da je potrebno izdvajati oko 15% godišnjih prihoda tokom radnog veka da biste ostvarili ovaj cilj.",
            keywords: ["penzija", "penzioner", "penzioni fond", "penziono", "starost", "penzionisanje", "treće doba", "trece doba", "fond PIO", "privatni penzioni fond", "dobrovoljni penzioni fond", "obavezni penzioni fond", "primanja u penziji", "penzijski sistem", "penziono osiguranje"]
        },
        dugoročni_ciljevi: {
            response: "Postavljanje i ostvarivanje dugoročnih finansijskih ciljeva zahteva razumevanje moći složene kamate i dugoročnog planiranja:\n\n1. Složena kamata je ključni princip koji omogućava eksponencijalni rast investicija tokom vremena\n2. Formula za izračunavanje konačne vrednosti uz složenu kamatu je: FV = PV * (1 + r)^n\n   - FV: konačna vrednost\n   - PV: početna investicija\n   - r: godišnja stopa prinosa (kao decimala)\n   - n: broj godina\n\n3. Za postizanje dugoročnog cilja, koristite naš finansijski kalkulator gde možete uneti:\n   - Početni iznos (jednokratna uplata)\n   - Mesečnu štednju (redovne uplate)\n   - Ciljani iznos\n   - Vremenski period\n   - Očekivanu stopu prinosa\n\nNa primer, ako počnete sa 10.000€ i želite doći do 300.000€ za 40 godina, uz pretpostavljeni godišnji prinos od 7%, potrebno je mesečno izdvajati oko 70€. Sa višom stopom prinosa od 9%, dovoljno je oko 25€ mesečno. Za personalizovanu analizu, molimo koristite naš kalkulator složene kamate.",
            keywords: ["dugoročni cilj", "dugorocni cilj", "dugoročno", "dugorocno", "složena kamata", "slozena kamata", "kamata na kamatu", "eksponencijalni rast", "za 10 godina", "za 20 godina", "za 30 godina", "za 40 godina", "duži period", "veliki iznos", "ostvariti cilj", "kalkulator", "izračunati", "izracunati", "finansijska nezavisnost", "penzijski fond", "penzionisanje", "finansijsko planiranje", "dupliranje novca", "uvećanje kapitala", "finansijska budućnost", "finansijska sloboda", "sedmogodišnje pravilo", "pravilo 72", "dugoročna investicija", "pasivni prihod", "finansijska sigurnost", "kroz vreme", "budućnost", "dugoročna strategija", "uvećati bogatstvo", "stvaranje bogatstva", "finansijski plan", "finansijski ciljevi"]
        },
        inflacija: {
            response: "Inflacija je stalni rast opšteg nivoa cena koji utiče na kupovnu moć vašeg novca tokom vremena. Za efikasnu zaštitu od inflacije:\n\n1. Investirajte u realna dobra poput nekretnina koje tradicionalno prate ili premašuju stopu inflacije\n2. Kupujte državne obveznice indeksirane prema inflaciji (npr. TIPS u SAD)\n3. Ulažite u akcije kvalitetnih kompanija koje mogu da prilagode cene inflaciji\n4. Diverzifikujte portfolio uključivanjem imovine koja služi kao zaštita od inflacije (zlato, robe)\n5. Izbegavajte držanje velike količine gotovine na duži period\n\nProsečna godišnja stopa inflacije u razvijenim ekonomijama je istorijski oko 2-3%, mada periodi visoke inflacije mogu značajno smanjiti vrednost štednje. Zato je važno imati strategiju investiranja koja uzima u obzir inflatorni rizik.",
            keywords: ["inflacija", "poskupljenje", "rast cena", "vrednost novca", "kupovna moć", "inflatorna spirala", "hiperinflacija", "indeks potrošačkih cena", "inflaciona stopa", "realna vrednost", "nominalna vrednost", "centralna banka", "monetarna politika", "deflacija", "stagflacija"]
        },
        finansijski_cilj: {
            response: "Za ostvarivanje specifičnog finansijskog cilja potrebno je napraviti konkretan plan koristeći principe složene kamate i redovne štednje. Naš kalkulator vam može pomoći da vidite kako različite stope prinosa i različiti iznosi mesečne štednje utiču na krajnji rezultat.\n\nEvo nekoliko primera za različite početne iznose i ciljeve:\n\n1. Sa početnim ulogom od 10.000€ i mesečnom štednjom od 100€, uz 7% godišnjeg prinosa:\n   • Za 20 godina: oko 85.000€\n   • Za 30 godina: oko 175.000€\n   • Za 40 godina: oko 335.000€\n\n2. Za postizanje cilja od 300.000€ uz početnih 10.000€ i 7% godišnjeg prinosa:\n   • Za 30 godina: potrebno je mesečno ulagati oko 225€\n   • Za 40 godina: potrebno je mesečno ulagati oko 70€\n\nPrincipi koji pomažu u dostizanju dugoročnih finansijskih ciljeva:\n1. Počnite što ranije - svaka godina je važna zbog efekta složene kamate\n2. Budite konzistentni - redovna mesečna ulaganja su ključna\n3. Reinvestirajte prinose - ne povlačite dividende i kamate\n4. Povećavajte iznos ulaganja kako vam rastu prihodi\n\nZa tačno planiranje vašeg ličnog cilja, preporučujem korišćenje našeg kalkulatora i konsultacije sa finansijskim savetnikom.",
            keywords: ["finansijski cilj", "cilj", "želim da uštedim", "zelim da ustedim", "želim da imam", "zelim da imam", "da dođem do", "da dodjem do", "dostići", "dostici", "konkretan iznos", "tačan iznos", "tacan iznos"]
        },
        akcije: {
            response: "Akcije (deonice) predstavljaju vlasnički udeo u kompaniji i jedan su od osnovnih investicionih instrumenata:\n\n1. Potencijal za dugoročni rast kapitala - istorijski, akcije beleže najveće prinose u dužem periodu\n2. Dividende - dodatni prihod od profita kompanije koji se isplaćuje akcionarima\n3. Likvidnost - mogućnost brze kupovine i prodaje na organizovanim tržištima\n4. Rizik - cene akcija mogu biti volatilne u kraćem periodu\n\nZa početak investiranja u akcije, razmotrite ETF-ove (fondovi koji prate berze) koji nude diversifikaciju i niže troškove. Indeksni fondovi koji prate S&P 500, MSCI World ili domaće indekse mogu biti dobra početna tačka sa istorijskim prinosom od oko 7-10% godišnje dugoročno.",
            keywords: ["akcije", "deonice", "berza", "berzansko trgovanje", "hartije od vrednosti", "dividenda", "broker", "akcionarsko društvo", "s&p 500", "belex", "blue chip", "tržišna kapitalizacija", "p/e racio", "cena akcije", "volatilnost", "likvidnost", "trgovanje akcijama"]
        },
        nekretnine: {
            response: "Investiranje u nekretnine je popularna strategija dugoročnog stvaranja bogatstva:\n\n1. Potencijal za aprecijaciju vrednosti tokom vremena\n2. Pasivan prihod od izdavanja\n3. Zaštita od inflacije - vrednost nekretnina često prati ili premašuje stopu inflacije\n4. Potencijalne poreske olakšice za vlasnike nekretnina\n5. Mogućnost korišćenja finansijskog leveridža (hipotekarni krediti)\n\nPri investiranju u nekretnine, ključni faktori su lokacija, stanje objekta, potencijal za rast vrednosti i odnos prihoda od izdavanja prema vrednosti nekretnine (tzv. yield). Za početnike, REIT fondovi (fondovi za ulaganje u nekretnine) mogu biti pristupačnija opcija sa manjim početnim ulaganjem.",
            keywords: ["nekretnina", "nekretnine", "stan", "kuća", "kuca", "plac", "zemljište", "investiciona nekretnina", "izdavanje", "renta", "yield", "najam", "stanarina", "hipoteka", "kvadratura", "kvadrat", "cena nekretnine", "lokacija", "reit", "stambeni kredit"]
        },
        složena_kamata: {
            response: "Složena kamata je jedan od najmoćnijih finansijskih koncepata i često se naziva 'osmim svetskim čudom'. Evo kako funkcioniše:\n\n1. Za razliku od proste kamate koja se obračunava samo na glavnicu, složena kamata se obračunava i na glavnicu i na prethodno zarađenu kamatu\n\n2. Formula za izračunavanje: A = P(1 + r/n)^(nt), gde je:\n   • A = konačni iznos\n   • P = početna glavnica\n   • r = godišnja kamatna stopa (u decimalnom zapisu)\n   • n = broj perioda kapitalizacije godišnje\n   • t = vreme u godinama\n\n3. Primeri rasta investicije od 10.000€ sa različitim stopama prinosa:\n   • 3% godišnje: nakon 20 godina = 18.061€\n   • 5% godišnje: nakon 20 godina = 26.533€\n   • 7% godišnje: nakon 20 godina = 38.697€\n   • 10% godišnje: nakon 20 godina = 67.275€\n\n4. Sa redovnim mesečnim uplatama rezultati su još impresivniji. Na primer, 200€ mesečno tokom 30 godina uz 7% prinosa daje oko 243.000€!\n\nVažno je razumeti da čak i mala razlika u stopi prinosa može dovesti do ogromne razlike u konačnom iznosu nakon dužeg vremenskog perioda. Zato je važno početi investirati što ranije i težiti najvišim razumno ostvarivim stopama prinosa za vaš nivo rizika.\n\nProbajte naš kalkulator da izračunate koliko će vredeti vaša investicija kroz vreme uz moć složene kamate.",
            keywords: ["složena kamata", "slozena kamata", "kamata na kamatu", "kapitalizacija kamate", "pravilo 72", "eksponencijalni rast", "reinvestiranje", "kamata", "obračun kamate", "kamatna stopa", "formula za kamatu", "izračunavanje kamate", "stopa prinosa", "godišnji prinos", "pasivni prihod", "formula za složenu kamatu", "finansijska formula", "rast novca", "sedmogodišnje pravilo", "udvostručiti novac", "dupliranje novca", "uvećanje investicije", "snaga kamate", "kumulativni prinos", "reinvestirana dobit", "reinvestirana dividenda", "kapitalizovana kamata", "kamata na kamatu na kamatu", "efekat lavine", "akumulacija bogatstva", "dugoročni rast", "efekat grude snega", "vremenska vrednost novca", "uvećanje vrednosti"]
        }
    };
    
    // Privatne pomoćne funkcije
    function findBestMatch(query) {
        query = query.toLowerCase();
        let bestCategory = 'default';
        let bestScore = 0;
        let investmentIntent = false;
        
        // Provera za dugoročne finansijske ciljeve (npr. "imam 10.000€, želim 300.000€ za 40 godina")
        const longTermGoalPattern = /imam\s+(\d+[\.,]?\d*)\s*[€$]?\s*.*?\s+[žz]elim\s+(\d+[\.,]?\d*)\s*[€$]?\s*.*?\s+za\s+(\d+)\s*god/i;
        const altLongTermGoalPattern = /[žz]elim\s+(\d+[\.,]?\d*)\s*[€$]?\s*.*?\s+za\s+(\d+)\s*god/i;
        const moneyAmountPattern = /(\d+[\.,]?\d*)\s*[€$]/i;
        
        // Provera za pitanja o složenoj kamati
        const compoundInterestPattern = /slo[žz]en[ae]\s*kamat[ae]|kamat[ae]\s*na\s*kamat[ae]|koliko\s+[cć]e\s+(bit[Ii]|vredeti)\s+(\d+[\.,]?\d*)\s*[€$]?\s+za\s+(\d+)\s*god|koliko\s+[cć]e\s+narasti|formul[ae]\s+za\s+slo[žz]enu\s+kamatu|ra[cč]un[ae]\s+slo[žz]en[ae]\s+kamat[ae]|duplira[nmt]|uve[cć]a[nmt]|eksponencijaln[iao]|rast za (\d+)\s*god/i;
        
        // Dodatni obrasci za prepoznavanje dugoročnih ciljeva
        const longTermPattern = /za\s+(\d+)\s*god|dugor[oa][cč]n[aoi]|nakon\s+(\d+)\s*god|kroz\s+(\d+)\s*god|kroz\s+vreme|tokom\s+vremena|budu[cć]nost|penzij[aeu]/i;
        const goalPattern = /([cć]ilj|plan|strategij[ae]|ostvariti|posti[cć]i|investicij[aeu]|ulo[žz]iti|finansijsk[aou]|nezavisnost)/i;
        
        // Ako pitanje sadrži specifičan obrazac za dugoročni cilj sa složenom kamatom
        if (longTermGoalPattern.test(query) || altLongTermGoalPattern.test(query) || 
            (moneyAmountPattern.test(query) && 
             (/za\s+(\d+)\s*god/.test(query) || /nakon\s+(\d+)\s*god/.test(query)) && 
             /[žz]elim|[žz]elela|[žz]eleo|ho[cć]u|ho[cć]em/.test(query))) {
            return 'dugoročni_ciljevi';
        }
        
        // Provera za pitanja o složenoj kamati
        if (compoundInterestPattern.test(query)) {
            return 'složena_kamata';
        }
        
        // Kombinovana provera za dugoročne ciljeve
        if (longTermPattern.test(query) && 
            (goalPattern.test(query) || moneyAmountPattern.test(query))) {
            return 'dugoročni_ciljevi';
        }
        
        // Proveravamo specifične obrasce za finansijske ciljeve
        if ((/imam\s+(\d+[\.,]?\d*)\s*[€$]?/.test(query) && /[žz]elim|do[cć]i do|ostvariti|posti[cć]i/.test(query)) ||
            (/kako\s+da\s+ostvarim\s+cilj/.test(query)) ||
            (/kako\s+da\s+do[dđ]em\s+do\s+(\d+[\.,]?\d*)\s*[€$]?/.test(query))) {
            return 'finansijski_cilj';
        }
        
        // Fraze i ključne reči koje ukazuju na nameru za investiranje ili savete o konkretnim investicijama
        const investmentIntentKeywords = [
            // Direktna namera za investiranje
            'želim da investiram', 'želim da uložim', 'hoću da investiram', 'hoću da uložim', 
            'planiram da investiram', 'planiram da uložim', 'razmišljam o ulaganju',
            'razmišljam o investiranju', 'zanima me investiranje', 'zanima me ulaganje',
            
            // Pitanja o specifičnim investicijama
            'gde da uložim', 'gde da investiram', 'u šta da ulažem', 'u šta da investiram', 
            'šta je najbolje za ulaganje', 'preporučite mi investiciju', 'koju investiciju preporučujete',
            
            // Pitanja o specifičnim finansijskim instrumentima
            'koji fond', 'koji fondovi', 'koje akcije', 'koje deonice', 'koji etf', 'koja ulaganja',
            'koju kriptovalutu', 'koje obveznice', 'koje nekretnine', 
            
            // Traženje pomoći ili konkretnih saveta
            'pomozite mi da investiram', 'pomozite mi da uložim', 'pomozite mi oko investicija',
            'savet za ulaganje', 'savet za investiranje', 'kako da počnem', 'kako da investiram',
            'kako da ulažem', 'savetujte me', 'treba mi savet', 'šta mi preporučujete',
            
            // Pitanja o konkretnim iznosima i proporcijama
            'koliko da uložim', 'koliko novca', 'koji procenat', 'koju sumu', 'koje iznose',
            'koliko bi trebalo', 'kako da rasporedim', 'kako da podelim portfolio',
            
            // Pitanja o konkretnoj situaciji i specifičnim ciljevima
            'imam X evra/dinara', 'dobio sam', 'nasledio sam', 'uštedeo sam', 'štedim za', 
            'investiram za penziju', 'investiram za decu', 'investiram za budućnost',
            
            // Želja za konkretnim finansijskim rezultatima
            'želim prinos od', 'želim zaradu', 'želim profit', 'želim povraćaj', 'želim da zaradim',
            'kako da ostvarim', 'kako da dobijem', 'kako da napravim'
        ];
        
        // Naprednija provera namere za investiranje sa kontekstualnom analizom
        // Prvo proveravamo tačna poklapanja fraza
        for (let intentKeyword of investmentIntentKeywords) {
            if (query.includes(intentKeyword)) {
                investmentIntent = true;
                break;
            }
        }
        
        // Dodatna provera kombinacija reči koje ukazuju na nameru
        if (!investmentIntent) {
            const actionVerbs = ['investirati', 'uložiti', 'ulagati', 'kupiti', 'trgovati', 'započeti'];
            const investmentNouns = ['investicija', 'ulaganje', 'akcija', 'deonica', 'fond', 'portfolio', 'novac', 'profit', 'zarada'];
            
            // Proveravamo kombinaciju glagol + imenica u blizini
            for (let verb of actionVerbs) {
                if (query.includes(verb)) {
                    for (let noun of investmentNouns) {
                        // Ako su glagol i imenica blizu u upitu (maksimalno 4 reči između), verovatno je namera za investiranje
                        const verbIndex = query.indexOf(verb);
                        const nounIndex = query.indexOf(noun);
                        
                        if (nounIndex !== -1 && Math.abs(verbIndex - nounIndex) < 20) {
                            investmentIntent = true;
                            break;
                        }
                    }
                }
                if (investmentIntent) break;
            }
        }
        
        if (investmentIntent) {
            return 'investment_intent'; // Posebna kategorija za nameru investiranja
        }
        
        // Naprednije pretraživanje - računamo skor za svaku kategoriju
        for (let category in knowledgeBase) {
            if (knowledgeBase[category].keywords) {
                // Za svaku kategoriju računamo skor
                let categoryScore = 0;
                
                for (let keyword of knowledgeBase[category].keywords) {
                    const keywordLower = keyword.toLowerCase();
                    
                    // Tačno podudaranje nosi više poena
                    if (query.includes(keywordLower)) {
                        // Duže ključne reči nose više poena
                        categoryScore += keywordLower.length * 2;
                        
                        // Bonus ako je ključna reč na početku upita
                        if (query.startsWith(keywordLower)) {
                            categoryScore += 10;
                        }
                    }
                    
                    // Delimična podudaranja nose manje poena
                    if (keywordLower.length > 4) {
                        const keywordParts = keywordLower.split(' ');
                        for (let part of keywordParts) {
                            if (part.length > 3 && query.includes(part)) {
                                categoryScore += part.length;
                            }
                        }
                    }
                }
                
                // Ažuriramo najbolji rezultat ako je trenutni skor bolji
                if (categoryScore > bestScore) {
                    bestScore = categoryScore;
                    bestCategory = category;
                }
            }
        }
        
        return bestScore > 0 ? bestCategory : 'default';
    }

    // Funkcija za testiranje prepoznavanja dugoročnih ciljeva
    function testLongTermGoalDetection() {
        const testCases = [
            { query: "Imam 10.000€, želim 300.000€ za 40 godina", expected: true },
            { query: "Imam 5000€, kako da dođem do 100.000€ za 20 godina?", expected: true },
            { query: "Želim da uštedim 50.000€ za 15 godina", expected: true },
            { query: "Kako da investiram 10.000 dinara?", expected: false },
            { query: "Koliko će vredeti moja investicija od 5000€ nakon 10 godina sa 7% prinosa?", expected: true },
            { query: "Objasni mi šta je složena kamata", expected: true },
            { query: "Koja je formula za složenu kamatu?", expected: true },
            { query: "Koliko će narasti 1000€ za 20 godina uz godišnji prinos od 8%?", expected: true },
            { query: "Želim da dupliran novac za 5 godina", expected: true },
            { query: "Ako uložim 20.000 dinara na 15 godina", expected: true },
            { query: "Dugoročna investicija od 30.000€", expected: true },
            { query: "Kako da steknem finansijsku nezavisnost za 20 godina?", expected: true }
        ];
        
        console.log("=== TEST PREPOZNAVANJA DUGOROČNIH CILJEVA I SLOŽENE KAMATE ===");
        testCases.forEach(test => {
            const result = chatBotAPI.isLongTermGoalQuestion(test.query);
            const success = result === test.expected;
            console.log(
                (success ? "✅" : "❌") + 
                " Query: \"" + test.query + "\"" +
                " | Expected: " + test.expected +
                " | Actual: " + result +
                " | Category: " + chatBotAPI.identifyTopic(test.query)
            );
        });
        console.log("==========================================");
    }

    // Funkcija za testiranje celokupnog sistema odgovora
    function testAllResponses() {
        const testQueries = [
            "Zdravo!",
            "Šta je složena kamata?",
            "Imam 10.000€, želim 300.000€ za 40 godina",
            "Kako da ostvarim dugoročni finansijski cilj?",
            "Želim da investiram, gde da počnem?",
            "Koliko će vredeti 5000€ nakon 20 godina sa 7% prinosa?",
            "Kako da napravim budžet?",
            "Šta je bolje, štednja ili investiranje?",
            "Kako da se zaštitim od inflacije?"
        ];
        
        console.log("=== TEST SISTEMA ODGOVORA ===");
        testQueries.forEach(query => {
            const category = chatBotAPI.identifyTopic(query);
            const response = chatBotAPI.getResponse(query);
            console.log(
                "Query: \"" + query + "\"\n" +
                "Category: " + category + "\n" +
                "Response: " + response.substring(0, 100) + "...\n" +
                "------------------------------------------"
            );
        });
        console.log("==========================================");
    }

    // Funkcija za testiranje celokupnog sistema odgovora za složenu kamatu
    function testCompoundInterestResponses() {
        const testQueries = [
            "Objasni mi šta je složena kamata",
            "Imam 10.000€, želim 300.000€ za 40 godina",
            "Koliko će vredeti 5000€ nakon 20 godina sa 7% prinosa?",
            "Želim da dupliran novac za 5 godina",
            "Ako uložim 20.000 dinara na 15 godina",
            "Dugoročna investicija od 30.000€",
            "Kako da steknem finansijsku nezavisnost za 20 godina?"
        ];
        
        console.log("=== TEST ODGOVORA ZA SLOŽENU KAMATU I DUGOROČNE CILJEVE ===");
        testQueries.forEach(query => {
            const category = chatBotAPI.identifyTopic(query);
            const response = chatBotAPI.getResponse(query);
            console.log(
                "Query: \"" + query + "\"\n" +
                "Category: " + category + "\n" +
                "Response: " + response.substring(0, 100) + "...\n" +
                "------------------------------------------"
            );
        });
        console.log("==========================================");
    }

    // Funkcija za napredno testiranje prepoznavanja složene kamate i dugoročnih finansijskih ciljeva
    function testAdvancedLongTermGoalDetection() {
        const advancedTestCases = [
            { query: "Kako da dupliran novac u narednih 7 godina?", expected: true, expectedCategory: "složena_kamata" },
            { query: "Koliko mi treba mesečno da uštedim da bih imao 100.000€ za 25 godina?", expected: true, expectedCategory: "dugoročni_ciljevi" },
            { query: "Ako želim da imam 500.000€ za penziju, koliko treba da štedim?", expected: true, expectedCategory: "dugoročni_ciljevi" },
            { query: "Kako da ostvarim finansijsku nezavisnost kroz investiranje?", expected: true, expectedCategory: "dugoročni_ciljevi" },
            { query: "Dugoročna strategija za uvećanje kapitala", expected: true, expectedCategory: "dugoročni_ciljevi" },
            { query: "Eksponencijalni rast investicije - kako to funkcioniše?", expected: true, expectedCategory: "složena_kamata" },
            { query: "Trenutna vrednost 1000€ mesečno na 30 godina", expected: true, expectedCategory: "dugoročni_ciljevi" },
            { query: "Sedmogodišnje pravilo za udvostručenje novca", expected: true, expectedCategory: "složena_kamata" },
            { query: "Kako da planiram finansijski za budućnost?", expected: true, expectedCategory: "dugoročni_ciljevi" }
        ];
        
        console.log("=== NAPREDNO TESTIRANJE SLOŽENE KAMATE I DUGOROČNIH CILJEVA ===");
        advancedTestCases.forEach(test => {
            const result = chatBotAPI.isLongTermGoalQuestion(test.query);
            const category = chatBotAPI.identifyTopic(test.query);
            const success = result === test.expected && (test.expectedCategory ? category === test.expectedCategory : true);
            
            console.log(
                (success ? "✅" : "❌") + 
                " Query: \"" + test.query + "\"" +
                " | Expected: " + test.expected +
                " | Actual: " + result +
                " | Expected Category: " + (test.expectedCategory || "any") +
                " | Actual Category: " + category
            );
        });
        console.log("==========================================");
    }

    // Funkcija za testiranje svih aspekata vezanih za dugoročne ciljeve i složenu kamatu
    function testAllLongTermFeatures() {
        console.log("=== KOMPLETNO TESTIRANJE SVIH FUNKCIONALNOSTI ZA DUGOROČNE CILJEVE I SLOŽENU KAMATU ===");
        
        // 1. Standardno testiranje prepoznavanja
        testLongTermGoalDetection();
        
        // 2. Napredno testiranje sa kategorijama
        testAdvancedLongTermGoalDetection();
        
        // 3. Testiranje odgovora
        testCompoundInterestResponses();
        
        // 4. Testiranje analize upita
        const analysisTestQueries = [
            "Imam 10.000€ i želim da dođem do 100.000€ za 20 godina. Kako to da ostvarim?",
            "Želim finansijsku nezavisnost za 25 godina, gde da počnem?",
            "Kako da udvostručim 5000€ za 7 godina?",
            "Koliko će vredeti mesečna investicija od 300€ nakon 30 godina sa 8% prinosa?",
            "Planiram penziju za 35 godina, koliki mesečni iznos mi treba?"
        ];
        
        console.log("=== TEST ANALIZE UPITA ZA DUGOROČNE CILJEVE ===");
        analysisTestQueries.forEach(query => {
            const analysis = chatBotAPI.analyzeQuery(query);
            console.log(
                "Query: \"" + query + "\"\n" +
                "Category: " + analysis.category + "\n" +
                "Is Long Term Goal: " + analysis.isLongTermGoal + "\n" +
                "Primary Interest: " + analysis.primaryInterest + "\n" +
                "Time Horizon: " + analysis.timeHorizon + "\n" +
                "Amount: " + analysis.amount + "\n" +
                "Recommended Tools: " + analysis.recommendedTools.join(", ") + "\n" +
                "------------------------------------------"
            );
        });
        
        console.log("=== KRAJ TESTIRANJA ===");
    }

    // Kreiranje čistog objekta za public API sa proširenim funkcionalnostima
    var chatBotAPI = {
        getResponse: function(query) {
            var category = findBestMatch(query);
            
            // Dodavanje dodatnog konteksta uz odgovor za investicione namere
            if (category === 'investment_intent') {
                return knowledgeBase[category].response + 
                      "\n\nZa finansijski uspeh je ključno imati personalizovani pristup koji uzima u obzir vaše specifične okolnosti i ciljeve.";
            }
            
            return knowledgeBase[category].response;
        },
        
        getGreeting: function() {
            return knowledgeBase.greeting.response;
        },
        
        // Metoda za prepoznavanje teme upita bez davanja odgovora
        identifyTopic: function(query) {
            return findBestMatch(query);
        },
        
        // Metoda koja proverava da li se radi o nameri za investiranje
        isInvestmentIntent: function(query) {
            return findBestMatch(query) === 'investment_intent';
        },
        
        // Metoda koja proverava da li se radi o pitanju vezanom za dugoročne ciljeve i složenu kamatu
        isLongTermGoalQuestion: function(query) {
            const result = findBestMatch(query);
            
            // Proširena lista kategorija vezanih za dugoročne ciljeve
            const longTermCategories = [
                'dugoročni_ciljevi', 
                'finansijski_cilj', 
                'složena_kamata',
                'investicije', // Uključujemo i investicije ako pitanje sadrži ključne reči za dugoročne ciljeve
                'penzija'      // Penzija je takođe dugoročni cilj
            ];
            
            // Proveravamo da li kategorija pripada dugoročnim ciljevima
            if (longTermCategories.includes(result)) {
                return true;
            }
            
            // Dodatna provera za investicije - da li se odnosi na dugoročno investiranje
            if (result === 'investicije' && 
                (/dugor[oa][cč]n[oi]|za (\d+) god|penzij[aeu]|budu[cć]nost/.test(query.toLowerCase()))) {
                return true;
            }
            
            return false;
        },
        
        // Metoda koja vraća nasumičan pozdrav iz nekoliko varijanti
        getRandomGreeting: function() {
            const greetings = [
                "Zdravo! Kako vam mogu pomoći sa finansijskim pitanjima danas?",
                "Dobrodošli u Golden Balance! Kako vam mogu pomoći?",
                "Pozdrav! Ja sam vaš AI finansijski asistent. Pitajte me bilo šta o finansijama!",
                "Zdravo! Spreman sam da odgovorim na vaša pitanja o finansijama, štednji i investiranju."
            ];
            return greetings[Math.floor(Math.random() * greetings.length)];
        },
        
        // Metoda koja vraća detaljniju analizu upita
        analyzeQuery: function(query) {
            const category = findBestMatch(query);
            const isLongTerm = this.isLongTermGoalQuestion(query);
            const isInvestment = this.isInvestmentIntent(query);
            
            // Detekcija primarnog interesa
            let primaryInterest = "Opšte finansije";
            if (isLongTerm) {
                primaryInterest = "Dugoročni finansijski ciljevi";
            } else if (isInvestment) {
                primaryInterest = "Investicioni saveti";
            }
            
            // Detekcija vremenskog horizonta
            let timeHorizon = "Neodređen";
            const yearMatch = query.match(/za\s+(\d+)\s*god/i);
            if (yearMatch && yearMatch[1]) {
                const years = parseInt(yearMatch[1]);
                if (years <= 5) {
                    timeHorizon = "Kratak rok (do 5 godina)";
                } else if (years <= 15) {
                    timeHorizon = "Srednji rok (5-15 godina)";
                } else {
                    timeHorizon = "Dug rok (preko 15 godina)";
                }
            } else if (/kratkor[oa][cč]n[oi]|brzog?|usko[rm]/i.test(query)) {
                timeHorizon = "Kratak rok (do 5 godina)";
            } else if (/sr[ae]dnj[ie]r[oa][cč]n[oi]/i.test(query)) {
                timeHorizon = "Srednji rok (5-15 godina)";
            } else if (/dugor[oa][cč]n[oi]|penzij[aeu]|budu[cć]nost/i.test(query)) {
                timeHorizon = "Dug rok (preko 15 godina)";
            }
            
            // Detekcija iznosa
            let amount = "Nije specificiran";
            const amountMatch = query.match(/(\d+[\.,]?\d*)\s*[€$]/i);
            if (amountMatch && amountMatch[1]) {
                const amountValue = parseFloat(amountMatch[1].replace(',', '.'));
                if (amountValue < 1000) {
                    amount = "Mali iznos (ispod 1.000€)";
                } else if (amountValue < 10000) {
                    amount = "Srednji iznos (1.000-10.000€)";
                } else if (amountValue < 100000) {
                    amount = "Veći iznos (10.000-100.000€)";
                } else {
                    amount = "Veliki iznos (preko 100.000€)";
                }
            }
            
            return {
                category: category,
                isLongTermGoal: isLongTerm,
                isInvestmentIntent: isInvestment,
                primaryInterest: primaryInterest,
                timeHorizon: timeHorizon,
                amount: amount,
                recommendedTools: isLongTerm ? ["Kalkulator složene kamate", "Planiranje budžeta", "Investicioni planovi"] : 
                                  isInvestment ? ["Konsultacije sa savetnikom", "Strategije investiranja"] : 
                                  ["Informativni članci", "Osnove finansija"]
            };
        },
        
        // Testna funkcija (samo u development modu)
        _testDetection: function() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                testLongTermGoalDetection();
                return true;
            } else {
                console.log("Testiranje je dostupno samo u development okruženju.");
                return false;
            }
        },
        
        // Napredno testiranje prepoznavanja složene kamate i dugoročnih ciljeva
        _testAdvancedDetection: function() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                testAdvancedLongTermGoalDetection();
                return true;
            } else {
                console.log("Testiranje je dostupno samo u development okruženju.");
                return false;
            }
        },
        
        // Testna funkcija za odgovore (samo u development modu)
        _testResponses: function() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                testAllResponses();
                return true;
            } else {
                console.log("Testiranje je dostupno samo u development okruženju.");
                return false;
            }
        },
        
        // Testna funkcija za odgovore specifično vezane za složenu kamatu
        _testCompoundInterestResponses: function() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                testCompoundInterestResponses();
                return true;
            } else {
                console.log("Testiranje je dostupno samo u development okruženju.");
                return false;
            }
        },
        
        // Testna funkcija koja izvršava sva testiranja vezana za dugoročne ciljeve i složenu kamatu
        _testAllLongTermFeatures: function() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                testAllLongTermFeatures();
                return true;
            } else {
                console.log("Testiranje je dostupno samo u development okruženju.");
                return false;
            }
        }
    };

    // Osiguravamo da se API ne može menjati i da knowledgeBase nije dostupan
    Object.freeze(chatBotAPI);
    
    // Osiguravamo da niko ne može pristupiti ovom modulu kroz debugger
    Object.defineProperty(global, '_chatBotKBModule', { 
        value: chatBotAPI,
        writable: false,
        configurable: false,
        enumerable: false
    });

    // Dodavanje API-ja na global objekat, ali samo ako već nije definisan
    if (typeof global.ChatBotKB === 'undefined') {
        global.ChatBotKB = chatBotAPI;
    }

    // Dodatno osiguranje da se ChatBotKB ne može menjati
    if (Object.freeze) {
        Object.freeze(global.ChatBotKB);
    }

    // Vraćamo samo API bez izlaganja baze znanja
    return chatBotAPI;
})(typeof window !== 'undefined' ? window : global);
